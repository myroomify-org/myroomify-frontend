<div class="container mb-5 animate-fade-in">
    <h2 class="mt-5 mb-5 section-title">User Management</h2>
    
    <div class="row g-3 mb-4 align-items-end search-filter-bar p-3 rounded shadow-sm">
        <div class="col-md-5">
            <label class="form-label text-muted small fw-bold">Search</label>
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                <input type="search" class="form-control border-start-0" 
                       placeholder="Name, email or id..." (input)="onSearch($event)">
            </div>
        </div>

        <div class="col-md-3">
            <label class="form-label text-muted small fw-bold">Sort</label>
            <select class="form-select" (change)="onSort($event)">
                <option value="id">Id (Default)</option>
                <option value="name">Name (A-Z)</option>
                <option value="email">Email (A-Z)</option>
                <option value="role">Role</option>
            </select>
        </div>
        
        <div class="col-md-4 text-end">
            <button class="btn btn-dark-green" (click)="setShowModal()">
                <i class="bi bi-person-plus-fill me-2"></i>New User
            </button>
        </div>
    </div>
    
    <div class="table-responsive rounded-4 shadow-sm bg-white">
        <table class="table table-hover bookingTable mb-0">
            <thead class="table-dark-green">
                <tr>
                    <th class="ps-4">Id</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                @for(user of filteredUsers; track user.id) {
                    <tr class="align-middle" [class.is-staff]="user.role === 'admin' || user.role === 'receptionist'" 
                    [class.is-me]="user.id === currentAdminId">
                        <td class="ps-4 text-muted">#{{ user.id }}
                            <span *ngIf="user.id === currentAdminId" class="badge bg-dark-green ms-1" style="font-size: 0.6rem;">YOU</span>
                        </td>
                        <td class="fw-bold">{{ user.name }}</td>
                        <td>{{ user.email }}</td>
                        <td>
                            <select class="form-select form-select-sm role-dropdown" 
                                    [value]="user.role" 
                                    (change)="changeRole(user, $any($event.target).value)">
                                <option value="superadmin">Superadmin</option>
                                <option value="admin">Admin</option>
                                <option value="receptionist">Receptionist</option>
                                <option value="customer">Customer</option>
                            </select>
                        </td>
                        <td class="text-center pe-4">
                            <div class="d-flex justify-content-center gap-2">
                                <button class="btn btn-sm" 
                                        (click)="toggleUserStatus(user)"
                                        [title]="user.is_active ? 'Deactivate' : 'Activate'">
                                    <mat-icon [class.text-success]="user.is_active" 
                                            [class.text-danger]="!user.is_active" 
                                            class="s-18">
                                        {{ user.is_active ? 'visibility' : 'visibility_off' }}
                                    </mat-icon>
                                </button>
                                
                                <button class="btn btn-delete btn-sm" (click)="confirmDelete(user.id)">
                                    <i class="bi bi-trash-fill"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                } @empty {
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="bi bi-people mb-2 d-block fs-2"></i>
                            There are no users.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="custom-modal" *ngIf="showModal">
        <div class="modal-content animate-fade-in">
            <div class="modal-header">
            <h5 class="color-dark-green fw-bold">Create New User</h5>
            <button class="btn-close" (click)="cancel()"></button>
            </div>
            
            <form [formGroup]="userForm" (ngSubmit)="addUser()" class="p-3">
            <div class="row g-3">
                <div class="col-md-6">
                <label class="form-label small fw-bold">Username</label>
                <input type="text" formControlName="name" class="form-control">
                </div>
                <div class="col-md-6">
                <label class="form-label small fw-bold">Email</label>
                <input type="email" formControlName="email" class="form-control">
                </div>
                <div class="col-md-6">
                    <label class="form-label small fw-bold">Role</label>
                    <select formControlName="role" class="form-select">
                        <option value="admin">Admin</option>
                        <option value="receptionist">Receptionist</option>
                        <option value="customer">Customer</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label small fw-bold">Initial Password</label>
                    <input type="password" formControlName="password" class="form-control">
                </div>
            </div>

            <div class="modal-footer mt-4">
                <button type="button" class="btn btn-outline-secondary" (click)="cancel()">Cancel</button>
                <button type="submit" class="btn btn-dark-green">Create User</button>
            </div>
            </form>
        </div>
        </div>
</div>